<!DOCTYPE html>
{% load static %}
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="{% static 'style.css' %}">
    <title>Top criptos</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>
<body>
    <div class="content">
        <div class="ranking">
            <h1>Top criptos</h1>
            <div id="dataDisplay"></div> <!-- Div para exibir dados da API -->
        </div>
        <div class="container">
            <div id="treemap"></div>
            <button id="loadDataButton" title="Recomendação de uso a cada 40 segundos.">Atualizar o mercado</button>
            <div class="form-container">
                <h1>Análise do mercado</h1>
                <form id="saveDetailForm" method="post" action="{% url 'save_data' %}">
                    {% csrf_token %}
                    {{ form.as_p }}
                    <button type="submit">Save</button>
                </form>
                <div id="formMessage" style="color: white; margin-top: 10px;"></div>
            </div>
        </div>
    </div>
    <script>
        $(document).ready(function() {
            function loadCryptoData() {
                $.ajax({
                    url: '/api/crypto?limit=10',
                    method: 'GET',
                    success: function(data) {
                        const treemap = $('#treemap');
                        const dataDisplay = $('#dataDisplay'); // Seletor para a nova div
                        treemap.empty(); // Limpar dados anteriores
                        dataDisplay.empty(); // Limpar dados anteriores

                        const cryptos = data.treemap;

                        // Define base size
                        const baseSize = 50; // Base size in pixels
                        const totalMarketCap = cryptos.reduce((acc, crypto) => acc + crypto.market_cap, 0);

                        // Calculate total area and size per unit of market cap
                        const totalArea = baseSize * baseSize;
                        const sizePerUnit = totalArea / totalMarketCap;

                        let currentTop = 0;
                        let currentLeft = 0;
                        let currentRowHeight = 0;
                        const maxRowWidth = 550; // Max width in pixels for each row

                        function formatCurrency(num) {
                            return new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' }).format(num);
                        }

                        cryptos.forEach(crypto => {
                            const marketCapPercentage = ((crypto.market_cap / totalMarketCap) * 100).toFixed(2);
                            const marketCapPercentageText = marketCapPercentage >= 1 ? marketCapPercentage + '%' : '';
                            const symbolFontSize = marketCapPercentage >= 2 ? '1.2em' : '0.5em';

                            const cryptoDiv = $('<div class="crypto" title="' + 'A capitalização de mercado de ' + crypto.name + ': ' + formatCurrency(crypto.market_cap) + '"></div>');

                            const symbolDiv = $('<div class="symbol"></div>').text(crypto.symbol).css({
                                fontSize: symbolFontSize
                            });
                            const marketCapPercentageDiv = $('<div class="market-cap-percentage"></div>').text(marketCapPercentageText).css({
                                fontSize: symbolFontSize
                            });;

                            cryptoDiv.append(marketCapPercentageDiv);
                            cryptoDiv.append(symbolDiv);

                            const size = crypto.market_cap * sizePerUnit;
                            const width = Math.min(size, maxRowWidth - currentLeft);
                            const height = width;

                            const color = crypto.market_cap > crypto.previous_market_cap ? '#28a745' : '#dc3545';

                            cryptoDiv.css({
                                width: width + 'px',
                                height: height + 'px',
                                top: currentTop + 'px',
                                left: currentLeft + 'px',
                                backgroundColor: color
                            });

                            treemap.append(cryptoDiv);

                            currentLeft += width;

                            if (currentLeft >= maxRowWidth) {
                                currentLeft = 0;
                                currentTop += currentRowHeight;
                                currentRowHeight = height;
                            } else {
                                currentRowHeight = Math.max(currentRowHeight, height);
                            }
                        });

                        // Display data in the new div
                        const dataHtml = cryptos.map(crypto => {
                            const marketCapClass = crypto.market_cap > crypto.previous_market_cap ? 'market-cap-up' : 'market-cap-down';

                            return `<div class="crypto-data">
                                <h2>${crypto.name} (${crypto.symbol})</h2>
                                <p class="${marketCapClass}">Capitalização de mercado: ${formatCurrency(crypto.market_cap)}</p>
                                <p class="${marketCapClass}">Capitalização de mercado anterior: ${formatCurrency(crypto.previous_market_cap)}</p>
                            </div>`;
                        }).join('');

                        dataDisplay.html(dataHtml);
                    },
                    error: function(error) {
                        console.error('Error fetching crypto data:', error);
                    }
                });
            }

            // Load data when the page loads
            loadCryptoData();

            // Reload data when the button is clicked
            $('#loadDataButton').click(function() {
                loadCryptoData();
            });

            // Handle form submission
            $('#saveDetailForm').on('submit', function(event) {
                event.preventDefault(); // Prevent the default form submission

                $.ajax({
                    url: $(this).attr('action'),
                    method: 'POST',
                    data: $(this).serialize(),
                    success: function(response) {
                        if (response.status === 'success') {
                            $('#formMessage').text('Os dados foram salvos com sucesso!');
                        } else {
                            $('#formMessage').text('Erro ao salvar: ' + response.message);
                        }
                    },
                    error: function(xhr) {
                        $('#formMessage').text('An error occurred: ' + xhr.status + ' ' + xhr.statusText);
                    }
                });
            });
        });
    </script>
</body>
</html>
